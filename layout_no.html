<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no,minimum-scale=1,maximum-scale=1">
        <title>ByChat AR</title>
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script type="text/javascript" src="https://cdn.webrtc.ecl.ntt.com/skyway-latest.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
        <script type="text/javascript" src="../socket.io/socket.io.js"></script>
        <script>
            ///////////////////////
            //  websocket 設定   //
            ///////////////////////
            // socket
            var socket, path, roomName;
            socket = io.connect();
            // path = location.pathname;
            // roomName = path.slice(1);
            roomName = "arTest";
            console.log(roomName);
            socket.emit("join", {value: roomName});
        </script>
        <style type="text/css">
            /* html 構造 */
            html, body {
                overflow: hidden;
                margin: 0;
                padding: 0;
            }

            /* ヘッダーの配置 */
            #header_area {
                height: 40px;
                background-color: #bccac6;
                width: 100vw;
                display: block;
                z-index: 20;
            }

            #header_contents {
                height: 100%;
                width: 100%;
                display: table;
                margin: 0;
                z-index: 19;
            }

            #header_left {
                width: 50px;
                height: 100%;
                display: table-cell;
                vertical-align: middle;
                margin: 0;
                padding-left: 15px;
                z-index: 18;
            }

            #header_right {
                width: auto;
                height: 100%;
                display: table-cell;
                vertical-align: middle;
                margin: 0;
                z-index: 17;
            }

            /* コンテンツエリアの配置 */
            #contents_area {
                height: 100vh;
                width: 100vw;
                margin-top: -45px;
                padding-top: 45px;
                display: block;
            }

            .main,
            .side {
                display: block;
                width: 100vw;
                height: calc(100vh - 45px);
                margin: 0;
                padding: 0;
                text-align: center;
                /*
                vertical-align: middle;
                */
            }            

            /* PCでのスタイル
            @media screen and (min-width: 1024px) {
                #menu_area {
                    width: 30vw;
                    height: calc(100vh - 45px);
                    text-align: center;
                    vertical-align: middle;
                    position: absolute;
                    left: 0;
                    top: 40px;
                    z-index: 10;
                }
           }
           */
           /*
            #canvas_container {
                z-index: 1;
            }
            */
            #video_area {
                background-color: #29029670;
                z-index: 7;
            }
            
            #chat_area {
                background-color: #02919677;
                z-index: 8;
            }
            
            #menu_area {
                background-color: black;
                overflow-y: scroll;
                z-index: 9;
            }

            .contents_container {
                display: inline-block;
                width: calc(100% - 30px);
                height: calc(100% - 30px);
                padding: auto;
                /*
                background-color: aliceblue;
                */
            }




            /* メニューのスタイル */
            ul {
                border: solid 2px silver;
                padding: 0 0.5em;
                /*
                position: relative;
                */
            }

            .menu_list {
                line-height: 20px;
                padding: 0.5em 0 0.5em 1.4em;
                border-bottom: dashed 1px silver;
                list-style-type: none;
                font-size: 16px;
                color: silver;
                text-align: center;
            }

            .menu_return {
                line-height: 20px;
                padding: 0.5em 0 0.5em 1.4em;
                border-bottom: dashed 1px silver;
                list-style-type: none;
                font-size: 16px;
                color: silver;
                text-align: left;
            }

            .file_label {
                font-size: 16px;
                color: silver;
                text-align: center;
            }

            /*
            .menu_list:before {
                font-family: "serif";
                content: "\f138";       /* アイコン種類 *
                position: absolute;
                left : 0.5em;           /* 左端からのアイコンまで *
                color: #02961b;         /* アイコン色 *
            }       
            */

            .menu_list:last-of-type {
                border-bottom: none;
            }        

            .review_list {
                height: 200px;
                padding: 0.5em 0 0.5em 1.4em;
                border-bottom: dashed 1px silver;
                list-style-type: none;
                text-align:center;
                vertical-align: middle;
            }

            .review_contents {
                margin: 0 40px;
            }

            #chat_review {
                height: 160px;
                overflow-y: scroll;
            }
            #video_review {
                overflow-y: scroll;
            }


            /* メニューアイコン */
            #humberger {
                margin: 2px 5px;
                left: 0;

                position: relative;
                height: 36px;
                width: 36px;
                /*
                display: inline-block;
                */
                box-sizing: border-box;
                background-color: #fff;
                border: 2px solid #444;
                border-radius: 4px;
                z-index: 16;
            }
            #humberger div {
                position: absolute;
                left: 4px;
                height: 4px;
                width: 24px;
                background-color: #444;
                border-radius: 2px;
                /*
                display: inline-block;
                */
                box-sizing: border-box;
            }
            #humberger div:nth-of-type(1) {
                top: 4px;
            }
            #humberger div:nth-of-type(2) {
                top: 14px;
            }
            #humberger div:nth-of-type(3) {
                bottom: 4px;
            }

            /* 名前欄 */
            #username_box {
                width: auto;
            }
            .header_contents {
                font-size: 16px;
            }

            #myNameForm {
                width: 100px;
            }

            .file_label {
                width: 100%;
                height: 100%;
            }



            /* chat area */

            #your_container{
                /* メッセージエリアの高さや幅などを設定 */

                height:100%;
                width: 100%;
            }
            /* チャットの外側部分① */
            #bms_messages_container{
                height: 100%;/*your_containerに対して100%になる */
                width: 100%;/*your_containerに対して100%になる */
                background-color: #eee;
            }

            /* ヘッダー部分② */
            #bms_chat_header {
                padding: 6px;/*隙間調整*/
                font-size: 16px;
                height: 30px;
                background: #ddd;
                border: 1px solid #ccc;
            }
                /* ステータスマークとユーザー名 */
                #bms_chat_user_status {
                    float: left;/* bms_chat_headerに対して左寄せ */
                }
                /* ステータスマーク */
                #bms_status_icon {
                    float: left;/* bms_chat_user_statusに対して左寄せ */
                    line-height: 2em;/*高さ調整*/
                }
                /* ユーザー名 */
                .bms_chat_user_name {
                    float: left;/* bms_chat_user_statusに対して左寄せ */
                    line-height: 2em;/*高さ調整*/
                    padding-left: 8px;
                }

            /* タイムライン部分③ */
            #bms_messages {
                overflow: auto;/* スクロールを効かせつつ、メッセージがタイムラインの外に出ないようにする */
                height:calc(100vh - 175px);/*テキストエリアが下に張り付く様にする*/
                border-right: 1px solid #ddd;
                border-left: 1px solid #ddd;
                background-color: #eee;
                box-shadow: 0px 2px 2px 0px rgba(0,0,0,0.2) inset;/*ヘッダーの下に影を入れる*/
            }
                /* メッセージ全般のスタイル */
                .bms_message {
                    margin: 0px;
                    padding: 0 14px;/*吹き出しがタイムラインの側面にひっつかない様に隙間を開ける*/
                    font-size: 16px;
                    word-wrap: break-word;/* 吹き出し内で自動で改行 */
                    white-space: normal;/*指定widthに合わせて、文字を自動的に改行*/
                }

                    .bms_message_box{
                        margin-top: 20px;/*上下の吹き出しがひっつかない様に隙間を入れる*/
                        max-width: 100%;/*文字が長くなった時に吹き出しがタイムラインからはみ出さない様にする*/
                        font-size: 16px;
                    }
                        .bms_message_content{
                            padding: 20px;/*文字や画像（コンテンツ）の外側に隙間を入れる*/
                        }
                
                /* メッセージ１（左側） */
                .bms_left {
                    float: left;/*吹き出しをbms_messagesに対して左寄せ*/
                    line-height: 1.3em;
                }

                        .bms_left .bms_message_box {
                            color: #333;/*テキストを黒にする*/
                            background: #fff;
                            border: 2px solid #13178E;
                            border-radius: 30px 30px 30px 0px;/*左下だけ尖らせて吹き出し感を出す*/
                            margin-right: 50px;/*左側の発言だとわかる様に、吹き出し右側に隙間を入れる*/
                        }
                
                /* メッセージ２（右側） */
                .bms_right {
                    float: right;/*吹き出しをbms_messagesに対して右寄せ*/
                    line-height: 1.3em;
                }

                        .bms_right .bms_message_box {
                            color: #fff;/*テキストを白にする*/
                            background: #13178E;
                            border: 2px solid #13178E;
                            border-radius: 30px 30px 0px 30px;/*右下だけ尖らせて吹き出し感を出す*/
                            margin-left: 50px;/*右側の発言だとわかる様に、吹き出し左側に隙間を入れる*/
                        }

                /* 回り込みを解除 */
                .bms_clear {
                    clear: both; /* 左メッセージと右メッセージの回り込み(float)の効果の干渉を防ぐために必要（これが無いと、自分より下のメッセージにfloatが影響する） */

                }

            /* テキストエリア、送信ボタン④ */
            #bms_send {
                background-color:#eee;/*タイムラインの色と同じにする*/
                border-right: 1px solid #ddd;
                border-left: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
                height: 50px;
                padding: 4px;
            }
                #bms_send_message{
                    width: calc(100% - 75px);/*常に送信ボタンの横幅を引いたサイズに動的に計算*/
                    line-height: 16px;
                    height: 48px;
                    padding: 14px 6px 0px 6px;/*文字がテキストエリアの中心になる様に隙間調整*/
                    border: 1px solid #ccc;
                    border-radius: 4px;/*角丸*/
                    text-align: left;/*文字を左寄せ*/
                    box-shadow: 2px 2px 4px 0px rgba(0,0,0,0.2) inset;/*内側に影を入れてテキストエリアらしくした*/
                    box-sizing: border-box;/*paddingとborderの要素の高さと幅の影響をなくす（要素に高さと幅を含める）*/
                    font-size: 16px;
                }
                #bms_send_btn {
                    width: 72px;
                    height: 48px;
                    font-size: 16px;
                    line-height: 3em;
                    float: right;/*bms_sendに対して右寄せ*/
                    color: #fff;
                    font-weight: bold;
                    background: #bcbcbc;
                    text-align: center;/*文字をボタン中央に表示*/
                    border: 1px solid #bbb;
                    border-radius: 4px;/*角丸*/
                    box-sizing: border-box;/*paddingとborderの要素の高さと幅の影響をなくす（要素に高さと幅を含める）*/
                }
                #bms_send_btn:hover {
                    background: #13178E; /*マウスポインタを当てた時にアクティブな色になる*/
                    cursor: pointer;/*マウスポインタを当てた時に、カーソルが指の形になる*/
                }    


        </style>
    </head>
    <body>
        <div id="header_area">
            <div id="header_contents">
                <div id="header_left">
                    <div id="humberger">
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
                <div id="header_right">
                    <div id="username_box">
                        Name: <input class="header_contents" type="text" id="myNameForm" />
                    </div>
                </div>
            </div>
        </div>
        <div id="contents_area">
            <!--
            <div id="canvas_area" class="main">
                <div id="canvas_container" class="contents_container">
                    <canvas id="myCanvas" style="background-color: #ffffe0; "></canvas>
                    <canvas id="back" style="display: none;"></canvas>
                </div>
            </div>

            -->
            <div id="chat_area" class="main">
                <div class="contents_container">
                    <div id="your_container">
                        <div id="bms_messages_container">
                            <div id="bms_chat_header">
                                <div id="bms_chat_user_status">
                                    <div id="bms_status_icon">●</div>
                                </div>
                            </div>
            
                            <div id="bms_messages">
            <!--
                                -- メッセージが送信されると以下が追加される --
                                <div class="bms_message bms_left">
                                    <div class="bms_message_box">
                                        <div class="bms_message_content">
                                            <div class="bms_message_text">私の発言</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bms_clear"></div>
            
                                <div class="bms_message bms_right">
                                    <div class="bms_message_box">
                                        <div class="bms_message_content">
                                            <div class="bms_message_text">相手の発言</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="bms_clear"></div>
            
                                -- 画像送信時は以下が　bms_message_content　に追加される --
                                <div class='bms_message_text'>
                                    「data.name」:　<br />
                                        <canvas id = 'thum_「thumb」' style = 'display: none;'></canvas><br />
                                        <canvas id = 'thum_「thumb」_mini' width = '150' height = '150'></canvas><br />
                                        <input type = 'button' class = '「thumb」' value = 'download' onClick = 'downloadThum(this)'></input> 
                                            <input type = 'button' class = '「thumb」' value = 'toBoard' onClick = 'toBoard(this)'></input>
                                </div>                                                             

            -->
                            </div>
            
                            <div id="bms_send">
                                <!--
                                <input type="file" name="thumfile" id="thum_file" accept="image/*"><br />
                                -->
                                <textarea id="bms_send_message"  onClick="bkCanvas()" ></textarea>
                                <div id="bms_send_btn" onClick="recoverCanvas()">送信</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="video_area" class="main">
                <div class="contents_container">
                    <div id="their-videos" style="display: inline-block; white-space: nowrap; height: 100%;">
                        <div id="self-video" style="display: inline-block;">
                        </div>
                    </div>
                </div>
            </div>
            <div id="menu_area" class="side">
                <div class="contents_container">
                    <ul id="menu_all">
                        <!--
                        <li id="sele_canvas" class="menu_list">描画メニュー</li>

                        -->
                        <li id="sele_video" class="menu_list">ビデオメニュー</li>
                        <li id="sele_chat" class="menu_list">チャットメニュー</li>
                        <li id="sele_mode_all" class="menu_list">モード変更</li>
                    </ul>
                    <!--
                    <ul id="menu_canvas">
                        <li id="sele_upstory_canvas" class="menu_return">← 戻る</li>
                        <li id="sele_color" class="menu_list">色彩メニュー</li>
                        <li id="sele_bold" class="menu_list">太さメニュー</li>
                        <li id="sele_eraser" class="menu_list">消去メニュー</li>
                        <li id="sele_updown" class="menu_list">画像化メニュー</li>
                        <li id="sele_mode_canvas" class="menu_list">モード変更</li>
                    </ul>

                    -->
                    <ul id="menu_video">
                        <li id="sele_upstory_video" class="menu_return">← 戻る</li>
                        <li id="sele_mute" class="menu_list">マイクオフ</li>
                        <li id="sele_blind" class="menu_list">ビデオオフ</li>
                        <li id="sele_getout" class="menu_list">退出</li>
                        <li id="sele_join" class="menu_list">入室</li>
                        <li id="sele_mode_video" class="menu_list">モード変更</li>
                    </ul>
                    <ul id="menu_chat">
                        <li id="sele_upstory_chat" class="menu_return">← 戻る</li>
                        <li id="sele_upToChat" class="menu_list">
                            <label class="file_label">
                                画像を送信
                                <input id="chat_file" type="file" name="file" accept="image/*" style="display: none;" />
                            </label>
                        </li>
                        <!--
                        <li id="sele_downFromChat" class="menu_list">チャットを保存</li>
                        -->
                        <li id="sele_mode_chat" class="menu_list">モード変更</li>
                    </ul>
                    <ul id="menu_mode">
                        <li id="sele_upstory_mode" class="menu_return">← 戻る</li>
                        <!--
                        <li id="sele_canvasMode" class="review_list">
                            <div id="canvas_review" class="review_contents">
                                <canvas id="review_canvas" width="192" height="128"></canvas>
                            </div>
                        </li>

                        -->
                        <li id="sele_videoMode" class="review_list">
                            <div id="video_review" class="review_contents">
                                <div class="pure-u-2-3" id="their-videos_review" style="display: inline-block; white-space: nowrap;">
                                </div>
                            </div>
                        </li>
                        <li id="sele_chatMode" class="review_list">
                            <div id="chat_review" class="review_contents">
                                <!-- 
                                    <div class="bms_message bms_right">
                                        <div class="bms_message_box">
                                            <div class="bms_message_content">
                                                <div class="bms_message_text">相手の発言</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="bms_clear"></div>
                                 -->
                            </div>
                        </li>
                        <li id="sele_pcMode" class="menu_list">PCバージョンへ</li>
                    </ul>
                    <!--
                    <ul id="menu_color">
                        <li id="sele_upstory_color" class="menu_return">← 戻る</li>
                        <li id="sele_black" class="menu_list">黒色</li>
                        <li id="sele_red" class="menu_list">赤色</li>
                        <li id="sele_green" class="menu_list">緑色</li>
                        <li id="sele_blue" class="menu_list">青色</li>
                        <li id="sele_white" class="menu_list">白色</li>
                    </ul>
                    <ul id="menu_bold">
                        <li id="sele_upstory_bold" class="menu_return">← 戻る</li>
                        <li id="sele_thin" class="menu_list">細い</li>
                        <li id="sele_normal" class="menu_list">標準</li>
                        <li id="sele_thick" class="menu_list">太い</li>
                        <li id="sele_superThick" class="menu_list">極太</li>
                        <li id="sele_paint" class="menu_list">塗り</li>
                    </ul>
                    <ul id="menu_eraser">
                        <li id="sele_upstory_eraser" class="menu_return">← 戻る</li>
                        <li id="sele_eraserColor" class="menu_list">消しゴム</li>
                        <li id="sele_clear" class="menu_list">全消去</li>
                    </ul>
                    <ul id="menu_updown">
                        <li id="sele_upstory_updown" class="menu_return">← 戻る</li>
                        <li id="sele_upload" class="menu_list">
                            <label class="file_label">
                                アップロード
                                <input id="canvas_file" type="file" name="file" accept="image/*" style="display: none;" />
                            </label>
                        </li>
                        <li id="sele_download" class="menu_list">ダウンロード</li>
                        <li id="sele_sendToChat" class="menu_list">チャットで送信</li>
                    </ul>

                    -->
                </div>
            </div>
        </div>

        
        <script>
            ////////////////////////////
            //  変数定義    //
            /////////////////
            // 画面遷移関係
            var mode, menu_story, clicked_swich, menu_judge;
            mode = "chat";

            //area
            var el_menu_area, el_canvas_area, el_video_area, el_chat_area;
            el_menu_area = document.getElementById("menu_area");
            // el_canvas_area = document.getElementById("canvas_container");
            el_video_area = document.getElementById("video_area");
            el_chat_area = document.getElementById("chat_area");

            // botan
            var b_humberger, b_canvas, b_chat, b_video, b_mode_all;
            var b_upstory_canvas, b_color, b_bold, b_eraser, b_updown, b_mode_canvas;
            var b_upstory_video, b_mute, b_blind, b_getout, b_join, b_mode_video;
            var b_upstory_chat, b_upToChat, b_downFromChat, b_mode_chat;
            var b_upstory_mode, b_canvasMode, b_videoMode, b_chatMode, b_pcMode;
            var b_upstory_color, b_black, b_red, b_green, b_blue, b_white;
            var b_upstory_bold, b_thin, b_normal, b_thick, b_superThick, b_paint;
            var b_upstory_eraser, b_eraserColor, b_clear;
            var b_upstory_updown, b_upload, b_download, b_sendToChat;
            
            b_humberger = document.getElementById("humberger");
            // b_canvas = document.getElementById("sele_canvas");
            b_chat = document.getElementById("sele_chat");
            b_video = document.getElementById("sele_video");
            b_mode_all = document.getElementById("sele_mode_all");

            /*
            b_upstory_canvas = document.getElementById("sele_upstory_canvas");
            b_color = document.getElementById("sele_color");
            b_bold = document.getElementById("sele_bold");
            b_eraser = document.getElementById("sele_eraser");
            b_updown = document.getElementById("sele_updown");
            b_mode_canvas = document.getElementById("sele_mode_canvas");
            */
            
            b_upstory_video = document.getElementById("sele_upstory_video");
            b_mute = document.getElementById("sele_mute");
            b_blind = document.getElementById("sele_blind");
            b_getout = document.getElementById("sele_getout");
            b_join = document.getElementById("sele_join");
            b_mode_video = document.getElementById("sele_mode_video");

            b_upstory_chat = document.getElementById("sele_upstory_chat");
            b_upToChat = document.getElementById("sele_upToChat");
            b_downFromChat = document.getElementById("sele_downFromChat");
            b_mode_chat = document.getElementById("sele_mode_chat");

            b_upstory_mode = document.getElementById("sele_upstory_mode");
            // b_canvasMode = document.getElementById("sele_canvasMode");
            b_videoMode = document.getElementById("sele_videoMode");
            b_chatMode = document.getElementById("sele_chatMode");
            b_pcMode = document.getElementById("sele_pcMode");

            /*
            b_upstory_color = document.getElementById("sele_upstory_color");
            b_black = document.getElementById("sele_black");
            b_red = document.getElementById("sele_red");
            b_green = document.getElementById("sele_green");
            b_blue = document.getElementById("sele_blue");
            b_white = document.getElementById("sele_white");

            b_upstory_bold = document.getElementById("sele_upstory_bold");
            b_thin = document.getElementById("sele_thin");
            b_normal = document.getElementById("sele_normal");
            b_thick = document.getElementById("sele_thick");
            b_superThick = document.getElementById("sele_superThick");
            b_paint = document.getElementById("sele_paint");

            b_upstory_eraser = document.getElementById("sele_upstory_eraser");
            b_eraserColor = document.getElementById("sele_eraserColor");
            b_clear = document.getElementById("sele_clear");

            b_upstory_updown = document.getElementById("sele_upstory_updown");
            b_upload = document.getElementById("sele_upload");
            b_download = document.getElementById("sele_download");
            b_sendToChat = document.getElementById("sele_sendToChat");
            */

            // input
            var input_canvas_file, input_chat_file, input_chat_name, uploadImgSrc, fileData, reader;
            // input_canvas_file = document.getElementById("canvas_file");
            input_chat_file = document.getElementById("chat_file");
            // input_chat_name = document.getElementById("chat_name");
            
            // updown
            var date, fileName, base64, blob, tmp, data, mime, buf, a;
            var img, iw, ih, imgAsp, canAsp, rat;
            /*
            // tex_canvasの初期設定
            var sx, sy, ex, ey, rsx, rsy, rex, rey;
            var color, bold, canvas, context, touching, mouse, cw, ch, cvw, cvh, position, revCanvas, revContext;
            color = "rgb(0,0,0)";
            bold = 5;
            canvas = document.getElementById("myCanvas");
            context = canvas.getContext('2d');
            touching = false;
            mouse = false;
            cw = canvas.offsetWidth + 500;
            ch = canvas.offsetHeight + 500;
            context.fillStyle = "#ffffe0";
            context.fillRect(0, 0, cw, ch);
            position = [];

            if($("#canvas_container").height()*3/2 > $("#canvas_container").width()) {
                $("#myCanvas").attr({width:$("#canvas_container").width()});
                $("#myCanvas").attr({height:$("#canvas_container").width()*2/3});
            }else {
                $("#myCanvas").attr({height:$("#canvas_container").height()});
                $("#myCanvas").attr({width:$("#canvas_container").height()*3/2});
            }
            
            // review_canvasの初期設定
            revCanvas = document.getElementById("review_canvas");
            revContext = revCanvas.getContext('2d');
            revContext.fillStyle = "#ffffe0";
            revContext.fillRect(0, 0, revCanvas.offsetWidth+10, revCanvas.offsetHeight+10);
            */
            
            // video
            var aud, vid, peerJudge;
            aud = true;
            vid = true;
            peerJudge = false;
            
            // chat
            var mes, nameForm, thumb_canvas, thumb, myName;
            myName = Math.floor(Math.random()*100) + "さん";
            nameForm = document.getElementById("myNameForm");
            nameForm.value = myName;

            thumb = 1;



            /////////////////////////
            //  画面遷移    //
            /////////////////
            //menu mode
            // b_canvasMode.onclick = openMode("canvas");
            // b_videoMode.onclick = openMode("video");
            // b_chatMode.onclick = openMode("chat");
            


            // menu button
            b_humberger.addEventListener("click", menuSwitch, false);

            // menu all 
            // b_canvas.onclick = openMenu("canvas");
            // b_video.onclick = openMenu("video");
            // b_chat.onclick = openMenu("chat");
            // b_mode_all.onclick = openMenu("mode");
            /*
            b_canvas.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("canvas");
                e.stopPropagation();
            }, false);
            */
            b_video.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("video");
                e.stopPropagation();
            }, false);
            b_chat.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("chat");
                e.stopPropagation();
            }, false);
            b_mode_all.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("mode");
                e.stopPropagation();
            }, false);

            // menu canvas
            // b_upstory_canvas.onclick = openMenu("all");
            // b_color.onclick = openMenu("color");
            // b_bold.onclick = openMenu("bold");
            // b_eraser.onclick = openMenu("eraser");
            // b_updown.onclick = openMenu("updown");
            // b_mode_canvas.onclick = openMenu("mode");
            /*
            b_upstory_canvas.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("all");
                e.stopPropagation();
            }, false);
            b_color.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("color");
                e.stopPropagation();
            }, false);
            b_bold.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("bold");
                e.stopPropagation();
            }, false);
            b_eraser.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("eraser");
                e.stopPropagation();
            }, false);
            b_updown.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("updown");
                e.stopPropagation();
            }, false);
            b_mode_canvas.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("mode");
                e.stopPropagation();
            }, false);
            */

            
            // menu video
            // b_upstory_video.onclick = openMenu("all");
            // b_mode_video.onclick = openMenu("mode");
            b_upstory_video.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("all");
                e.stopPropagation();
            }, false);
            b_mute.addEventListener("click", switch_audio, false);
            b_blind.addEventListener("click", switch_video, false);
            b_getout.addEventListener("click", getoutRoom, false);
            b_join.addEventListener("click", connectPeer, false);
            b_mode_video.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("mode");
                e.stopPropagation();
            }, false);


            // menu chat
             b_upstory_chat.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("all");
                e.stopPropagation();
            }, false);
            // b_mode_chat.onclick = openMenu("mode");
            // b_upstory_chat.addEventListener("click", openMenu("all"), false);
            input_chat_file.addEventListener("change", loadLocalThum, false);
            // b_downFromChat.addEventListener("click", downloadChat, false);
            b_mode_chat.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("mode");
                e.stopPropagation();
            }, false);


            // menu mode
            // b_upstory_mode.onclick = openMenu("all");
            b_upstory_mode.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("all");
                e.stopPropagation();
            }, false);
            /*
            b_canvasMode.addEventListener("click", function(e) {
                e.preventDefault();
                openMode("canvas");
                e.stopPropagation();
            }, false);
            */
            b_videoMode.addEventListener("click", function(e) {
                e.preventDefault();
                openMode("video");
                e.stopPropagation();
            }, false);
            b_chatMode.addEventListener("click", function(e) {
                e.preventDefault();
                openMode("chat");
                e.stopPropagation();
            }, false);
            b_pcMode.addEventListener("click", openPcMode, false);
            
            
            // menu color
            // b_upstory_color.onclick = openMenu("canvas");
            /*
            b_upstory_color.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("canvas");
                e.stopPropagation();
            }, false);
            b_black.addEventListener("click", function(e) {
                e.preventDefault();
                changeColor("rgb(0,0,0)");
                e.stopPropagation();
                }, false);
            b_red.addEventListener("click", function(e) {
                e.preventDefault();
                changeColor("rgb(255,0,0)");
                e.stopPropagation();
                }, false);
            b_green.addEventListener("click", function(e) {
                e.preventDefault();
                changeColor("rgb(0,255,0)");
                e.stopPropagation();
                }, false);
            b_blue.addEventListener("click", function(e) {
                e.preventDefault();
                changeColor("rgb(0,0,255)");
                e.stopPropagation();
                }, false);
            b_white.addEventListener("click", function(e) {
                e.preventDefault();
                changeColor("#ffffe0");
                e.stopPropagation();
                }, false);
            
            
            // menu bold
            // b_upstory_bold.onclick = openMenu("canvas");
            b_upstory_bold.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("canvas");
                e.stopPropagation();
            }, false);
            b_thin.addEventListener("click", function(e) {
                e.preventDefault();
                changeBold(1);
                e.stopPropagation();
            }, false);
            b_normal.addEventListener("click", function(e) {
                e.preventDefault();
                changeBold(5);
                e.stopPropagation();
            }, false);
            b_thick.addEventListener("click", function(e) {
                e.preventDefault();
                changeBold(10);
                e.stopPropagation();
            }, false);
            b_superThick.addEventListener("click", function(e) {
                e.preventDefault();
                changeBold(20);
                e.stopPropagation();
            }, false);
            b_paint.addEventListener("click", function(e) {
                e.preventDefault();
                changeBold(50);
                e.stopPropagation();
            }, false);


            // menu eraser
            // b_upstory_eraser.onclick = openMenu("canvas");
            b_upstory_eraser.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("canvas");
                e.stopPropagation();
            }, false);
            b_eraserColor.addEventListener("click", function(e) {
                e.preventDefault();
                changeColor("#ffffe0");
                e.stopPropagation();
                }, false);
            b_clear.addEventListener("click", allClear, false);

            
            // menu updown
            // b_upstory_updown.onclick = openMenu("canvas");
            b_upstory_updown.addEventListener("click", function(e) {
                e.preventDefault();
                openMenu("canvas");
                e.stopPropagation();
            }, false);
            input_canvas_file.addEventListener("change", loadLocalImage, false);
            // b_downFromChat.addEventListener("click", downloadChat, false);
            b_download.addEventListener("click", downCanvas, false);
            b_sendToChat.addEventListener("click", toChat, false);
            */


            // input name
            nameForm.addEventListener("change", changeName, false);


            // clear all area
            function resetMode() {
                console.log("resetMode");
                // document.getElementById("canvas_area").style.display = "none";
                document.getElementById("video_area").style.display = "none";
                document.getElementById("chat_area").style.display = "none";
                document.getElementById("menu_area").style.display = "none";
            }
            // clear all menu
            function resetMenu() {
                console.log("resetMenu");
                document.getElementById("menu_all").style.display = "none";
                // document.getElementById("menu_canvas").style.display = "none";
                document.getElementById("menu_video").style.display = "none";
                document.getElementById("menu_chat").style.display = "none";
                document.getElementById("menu_mode").style.display = "none";
                // document.getElementById("menu_color").style.display = "none";
                // document.getElementById("menu_bold").style.display = "none";
                // document.getElementById("menu_eraser").style.display = "none";
                // document.getElementById("menu_updown").style.display = "none";
            }
            // open certain area
            function openMode(modeName) {
                console.log("openMode");
                resetMode();
                mode = modeName;
                openMenu(modeName);
                modeName = modeName + "_area"
                document.getElementById(modeName).style.display = "block";
            }
            // open certain menu
            function openMenu(menuName) {
                console.log("openMenu");
                menu_story = "menu_" + menuName;
                resetMenu();
                document.getElementById(menu_story).style.display = "block";
            }
            openMenu(mode);
            openMode(mode);
            
            // menu button 
            // b_humberger.onclick = menuSwitch();

            // opne or close menu area
            function menuSwitch(e) {
                // e.preventDefault();
                console.log("menuSwitch");
                menu_judge = document.getElementById("menu_area").style.display;
                if(menu_judge == "none") {
                    resetMode();
                    document.getElementById("menu_area").style.display = "block";
                }else {
                    document.getElementById("menu_area").style.display = "none";
                    openMode(mode);
                }
                // e.stopPropagation();
            }

            function openPcMode(e) {
                // location.href = "https://webchat-for-learning-test.herokuapp.com/" + roomName + ".html";
                location.href = "https://webchat-for-learning-test.herokuapp.com/layout_chat.html";
            }


            /////////////////
            //  AR描画  //
            //////////////
            // change color
            function changeColor(col) {
                color = col;
                menuSwitch();
            }

            // change bold
            function changeBold(bol) {
                bold = bol;
                menuSwitch();
            }

            // clear all
            /*
            socket.on('eraseAll', function (data) {
                canvas = document.getElementById("myCanvas");
                context = canvas.getContext('2d');
                var cw = canvas.offsetWidth + 500;
                var ch = canvas.offsetHeight + 500;
                context.fillStyle = "#ffffe0";
                context.fillRect(0, 0, cw, ch);
                // review_canvas
                revCanvas = document.getElementById("review_canvas");
                revContext = revCanvas.getContext('2d');
                var rcw = revCanvas.offsetWidth + 500;
                var rch = revCanvas.offsetHeight + 500;
                revContext.fillStyle = "#ffffe0";
                revContext.fillRect(0, 0, rcw, rch);
            });
            function allClear(e) {
                socket.emit('erase', { value: true, id: roomName });
                menuSwitch();
            }
            */

            // b_download.onclick = downCanvas();
            // download picture from canvas
            function toPicture(cnv) {
                date = new Date();
                // var canvas = document.getElementById("myCanvas");
                fileName = date.getFullYear().toString()  + date.getDate().toString() + (date.getHours() + 1).toString() + date.getMinutes().toString() + date.getSeconds().toString() + ".png";
                base64 = cnv.toDataURL("image/png");
                blob = toBlob(base64);
                saveBlob(blob, fileName);
                menuSwitch();
            }
            function toBlob(base64) {
                tmp = base64.split(',');
                data = atob(tmp[1]);
                mime = tmp[0].split(':')[1].split(';')[0];
                buf = new Uint8Array(data.length);
                for (var i = 0; i < data.length; i++) {
                    buf[i] = data.charCodeAt(i);
                }
                blob = new Blob([buf], { type: mime });
                return blob;
            }
            function saveBlob(blob, fileName) {
                a = document.createElement('a');
                a.download = fileName;
                a.target = '_blank';

                if (window.navigator.msSaveBlob) {
                    window.navigator.msSaveBlob(blob, fileName)
                }
                else if (window.URL && window.URL.createObjectURL) {
                    a.href = window.URL.createObjectURL(blob);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                }
                else if (window.webkitURL && window.webkitURL.createObject) {
                    a.href = window.webkitURL.createObjectURL(blob);
                    a.click();
                }
                else {
                    window.open('data:' + mime + ';base64,' + window.Base64.encode(buf), '_blank');
                }
            }
            /*
            function downCanvas(e) {
                canvas = document.getElementById("myCanvas");
                toPicture(canvas);
            }

            // upload picture to canvas
            // Canvas上に画像を表示する
            function drawImgOnCvs(data) {
                canvas = document.getElementById("myCanvas");
                context = canvas.getContext('2d');
                context.imageSmoothingQuality = "high";
                // canvas内の要素をクリアする
                cvw = canvas.width;
                cvh = canvas.height;
                context.fillStyle = "#ffffe0";
                context.fillRect(0, 0, cvw, cvh);

                // review_canvas
                revCanvas = document.getElementById("review_canvas");
                revContext = revCanvas.getContext('2d');
                rcw = revCanvas.width;
                rch = revCanvas.height;
                revContext.fillStyle = "#ffffe0";
                revContext.fillRect(0, 0, rcw, rch);


                // tex_canvas上に画像を表示
                img = new Image();
                img.src = data.value;
                img.onload = function() {
                    iw = this.width;
                    ih = this.height;
                    imgAsp = iw/ih;
                    canAsp = 3/2;
                    if (imgAsp < canAsp) {
                        // iw = cvh * imgAsp;
                        context.drawImage(img, 0, 0, cvh * imgAsp, cvh);
                        revContext.drawImage(img, 0, 0, imgAsp*rch, rch);
                    }else {
                        ih = cvw / imgAsp;
                        context.drawImage(img, 0, 0, cvw, cvw / imgAsp);
                        revContext.drawImage(img, 0, 0, rcw, rcw/imgAsp);
                    }
                }


            }
            socket.on("returnImg", function(data) {
                drawImgOnCvs(data);
            });
            function loadLocalImage(e) {
                // ファイル情報を取得
                fileData = e.target.files[0];

                // 画像ファイル以外は処理を止める
                if(!fileData.type.match('image.*')) {
                    alert('画像を選択してください');
                    return;
                }

                // FileReaderオブジェクトを使ってファイル読み込み
                reader = new FileReader();
                // ファイル読み込みに成功したときの処理
                reader.onload = function(e) {
                    // Canvas上に表示する
                    uploadImgSrc = e.target.result;
                    socket.emit("sendImg", { value: uploadImgSrc, id: roomName, name: myName });
                    socket.emit("sendThum", { value: uploadImgSrc, id: roomName, name: myName });
                }
                // ファイル読み込みを実行
                reader.readAsDataURL(fileData);
                openMenu(mode);
            }
            // ファイルが指定された時にloadLocalImage()を実行
            // input_canvas_file.addEventListener('change', loadLocalImage, false);

            function toChat(e) {
                canvas = document.getElementById("myCanvas");
                base64 = canvas.toDataURL("image/png");
                socket.emit("canvasToChat", { value: base64, id: roomName, name: myName });
                menuSwitch();
            }
            // b_sendToChat.onclick = toChat();



            //Write
            socket.on('posit', function (data) {
                // myCanvas
                var cvw = document.getElementById("myCanvas").width;
                var cvh = document.getElementById("myCanvas").height;
                var canvas = document.getElementById("myCanvas");
                var context = canvas.getContext('2d');
                context.beginPath();
                context.lineCap = "round";
                context.strokeStyle = data[4];
                context.lineWidth = data[5];
                context.moveTo(data[0]*cvw, data[1]*cvh);
                context.lineTo(data[2]*cvw, data[3]*cvh);
                context.stroke();
                //review_canvas
                var rcvw = document.getElementById("review_canvas").width;
                var rcvh = document.getElementById("review_canvas").height;
                revCanvas = document.getElementById("review_canvas");
                revContext = revCanvas.getContext('2d');
                revContext.beginPath();
                revContext.lineCap = "round";
                revContext.strokeStyle = data[4];
                revContext.lineWidth = data[5];
                revContext.moveTo(data[0]*cvw, data[1]*cvh);
                revContext.lineTo(data[2]*cvw, data[3]*cvh);
                revContext.stroke();
                
            });


            // ウィンドウサイズの変更や回転時のサイズ調整
            $(window).on("orientationchange resize load", function(){
                var canvas = document.getElementById("myCanvas");
                var context = canvas.getContext('2d');
                var base64 = canvas.toDataURL("image/png");
                context.imageSmoothingQuality = "high";
                if($("#canvas_container").height()*3/2 > $("#canvas_container").width()) {
                    $("#myCanvas").attr({width:$("#canvas_container").width()});
                    $("#myCanvas").attr({height:$("#canvas_container").width()*2/3});
                }else {
                    $("#myCanvas").attr({height:$("#canvas_container").height()});
                    $("#myCanvas").attr({width:$("#canvas_container").height()*3/2});
                }
                var cw = canvas.offsetWidth + 500;
                var ch = canvas.offsetHeight + 500;
                context.fillStyle = "#ffffe0";
                context.fillRect(0, 0, cw, ch);
                var bkData = new Image();
                bkData.onload = function() {
                    context.drawImage(bkData, 0, 0, canvas.width, canvas.height);
                }
                bkData.src = base64;
            });


            //タッチスタート
            canvas.addEventListener("touchstart", onTouchStart, false);
            function onTouchStart(e) {
                    // e.preventDefault();
                    console.log("タッチスタート");
                    var touch = e.changedTouches[0];
                    var rect = e.target.getBoundingClientRect();
                    sx = touch.clientX - rect.left;
                    sy = touch.clientY - rect.top;
                    console.log(sx);
                    console.log(sy);
                    touching = true;
                    // e.stopPropagation();
            }
            
                //タッチムーブ
            canvas.addEventListener("touchmove", onTouchMove, false);
            function onTouchMove(e) {
                if(e.touches.length == 1) {
                    e.preventDefault();
                    console.log("タッチムーブ");
                    var touch = e.changedTouches[0];
                    var cvw = document.getElementById("myCanvas").width;
                    var cvh = document.getElementById("myCanvas").height;
                    　var rect = e.target.getBoundingClientRect();
                    　ex = touch.clientX - rect.left;
                    　ey = touch.clientY - rect.top;
                    console.log(sx);
                    console.log(sy);
                    console.log(ex);
                    console.log(ey);
                    rsx = sx / cvw;
                    rsy = sy / cvh;
                    rex = ex / cvw;
                    rey = ey / cvh; 
                    position = [rsx, rsy, rex, rey, color, bold];
                    if (touching === true) {
                        socket.emit('pos', { value: position , id: roomName});
                        sx = ex;
                        sy = ey;
                        position = [];
                    }
                    e.stopPropagation();
                }
            }

            canvas.addEventListener("touchend", onTouchEnd, false);
            function onTouchEnd(e) {
                    // e.preventDefault();
                    console.log("タッチエンド");
                    console.log(sx);
                    console.log(sy);
                    var touch = e.changedTouches[0];
                    touching = false;
                    // e.stopPropagation();
            }


            canvas.addEventListener("mousedown", onMouseDown, false);
            function onMouseDown(e) {
                console.log("マウスダウン");
                　var rect = event.target.getBoundingClientRect();
                sx = event.clientX - rect.left;
                sy = event.clientY - rect.top;
                mouse = true;
            }

            canvas.addEventListener("mousemove", onMouseMove, false);
            function onMouseMove(e) {
                console.log("マウスムーブ");
                e.preventDefault();
                var cvw = document.getElementById("myCanvas").width;
                var cvh = document.getElementById("myCanvas").height;
                　var rect = event.target.getBoundingClientRect();
                ex = event.clientX - rect.left;
                ey = event.clientY - rect.top;
                rsx = sx / cvw;
                rsy = sy / cvh;
                rex = ex / cvw;
                rey = ey / cvh; 
                position = [rsx, rsy, rex, rey, color, bold];
                if (mouse === true) {
                    socket.emit('pos', { value: position, id: roomName });
                }
                sx = ex;
                sy = ey;
                position = [];
                e.stopPropagation();
            }

            canvas.addEventListener("mouseup", onMouseUp, false);
            function onMouseUp(e) {
                console.log("マウスアップ");
                mouse = false;
            }
            */


            /////////////////////////
            //  ビデオチャット  //
            /////////////////////
            //==================================================================
            //  ビデオチャット実装
            //==================================================================

            // video chat

            /*
            var localStream = null;
            var peer = null;
            var existingCall = null;
            var room;
            peer = new Peer({
                key: '2647af86-51da-4e29-be21-abb6af7e1016',
                debug: 3
            });

            
            peer.on('open', function(){
                function connectPeer(e) {
                   peerJudge = true;

                    // confirm log
                    console.log("peerOpen");
                    socket.emit("log", {value: "peerOpen"});

                    $('#self-video').append($(
                        '<video id="my-video" height="140px" width="210px" muted="true" style="display: inline-block; position: -webkit-sticky;" autoplay playsinline></video>' +
                        '<div class="my-name" id="name_' + peer.id + '" style="height: 25px; margin: 0; padding: 0; background-color: #333333; color: #ffffff; position: relative; z-index:10;">' + 
                            myName + 
                        '</div>'));
                    navigator.mediaDevices = navigator.mediaDevices || ((navigator.mozGetUserMedia || navigator.webkitGetUserMedia) ? {
                        getUserMedia: function(c) {
                            return new Promise(function(y, n) {
                            (navigator.mozGetUserMedia ||
                                navigator.webkitGetUserMedia).call(navigator, c, y, n);
                            });
                        }
                    } : null);

                    if (!navigator.mediaDevices) {
                        console.log("getUserMedia() not supported.");
                        return;
                    }
                    var constraints = { 
                        video: { 
                            frameRate: { ideal: 10, max: 30 }, 
                            width: { min: 160, ideal: 640, max: 1920 }, 
                            height: { min: 120, ideal: 480, max: 1080 }
                        },  
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }};


                    navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                        $('#my-video').get(0).srcObject = stream;
                        localStream = stream;

                        // トラックを取り出す
                        videoTrack = stream.getVideoTracks()[0];
                        audioTrack = stream.getAudioTracks()[0];

                        room = peer.joinRoom('mesh_video_' + roomName, {stream: localStream});
                        room.on('stream', stream => {
                            const peerId = stream.peerId;
                            const id = peerId + '_' + stream.id.replace('{', '').replace('}', '');

                            $('#their-videos').append($(
                            '<div class="video_' + peerId +'" id="video_' + id + '" style="display: inline-block; margin:5px; width: 95%; height: 95%;">' + 
                                '<div class="peer-name" id="name_' + peerId + '" style="height: 25px; background-color: rgba(50,50,50,0.5); color: #ffffff; position: relative; font-size: 16px; z-index:10;">' + 
                                    "guest" + 
                                '</div>' + 
                                '<div class="peer-audio" id="mute_' + peerId + '" style="height: 25px; background-color: red; color: black; font-size: 16px; display: none; position: relative; z-index:10;">音声オフ</div>' + 
                                '<div class="peer-video" style="display: inline-block; width: 100%; height: 100%; margin-top: -25px;">' + 
                                    '<video class="remoteVideos" height="100%" width="100%" style="display: inline-block; position: -webkit-sticky;" autoplay playsinline></video>' +
                                    '<audio class="remoteAudios" style="display: none;" autoplay playsinline></audio>' + 
                                '</div>' + 
                            '</div>'));
                            $('#their-videos_review').append($(
                            '<div class="video_' + peerId +'" id="video_' + id + '_review" style="display: inline-block; margin:5px; width: 95%; height: 95%;">' + 
                                '<div class="peer-name" id="name_' + peerId + '_review" style="height: 25px; background-color: rgba(50,50,50,0.5); color: #ffffff; position: relative; font-size: 16px; z-index:10;">' + 
                                    "guest" + 
                                '</div>' + 
                                '<div class="peer-audio" id="mute_' + peerId + '_review" style="height: 25px; background-color: red; color: black; font-size: 16px; display: none; position: relative; z-index:10;">音声オフ</div>' + 
                                '<div class="peer-video" style="display: inline-block; width: 100%; height: 100%; margin-top: -25px;">' + 
                                    '<video class="remoteVideos" height="100%" width="100%" style="display: inline-block; position: -webkit-sticky;" autoplay playsinline></video>' +
                                '</div>' + 
                            '</div>'));
                            const el = $('#video_' + id).find('video').get(0);
                            const revel = $('#video_' + id + '_review').find('video').get(0);
                            const ael = $('#video_' + id).find('audio').get(0);
                            el.muted = true;
                            el.srcObject = stream;
                            revel.muted = true;
                            revel.srcObject = stream;
                            ael.srcObject = stream;
                            el.play();
                            revel.play();
                            ael.play();
                            defName();
                        });




                        room.on('removeStream', function(stream) {
                            const peerId = stream.peerId;
                            $('#video_' + peerId + '_' + stream.id.replace('{', '').replace('}', '')).remove();
                            $('#video_' + peerId + '_' + stream.id.replace('{', '').replace('}', '') + '_review').remove();
                        });

                        // UI stuff
                        room.on('close', function() {
                            room.close();
                            peerJudge = false;
                            $('#their-videos').empty();
                            $('#their-videos_review').empty();
                            $('#self-video').empty();
                            document.getElementById("sele_join").style.backgroundColor = "black";
                        });
                        room.on('peerLeave', peerId => {
                            $('.video_' + peerId).remove();
                            $('.video_' + peerId + '_review').remove();
                        });
                    });
                    document.getElementById("sele_join").style.backgroundColor = "red";
                    menuSwitch();
                } 

                function getoutRoom(e) {
                    if(peerJudge) {
                        room.close();
                        peerJudge = false;
                        $('#their-videos').empty();
                        $('#their-videos_review').empty();
                        $('#self-video').empty();
                        document.getElementById("sele_join").style.backgroundColor = "black";
                    }else {
                        alert("peer disconnected!");
                    }
                    menuSwitch();
                }

                function switch_audio(e) {
                    if(peerJudge) {
                        if (aud == true) {
                            // ビデオをmuteする
                            audioTrack.enabled = false;
                            aud = false;
                            document.getElementById("sele_mute").style.backgroundColor = "red";
                            if(peer.id !== undefined){
                                socket.emit("audioMute", {judge: aud ,value: peer.id, id: roomName, name: myName});
                            }
                        }else {
                            audioTrack.enabled = true;
                            aud = true;
                            document.getElementById("sele_mute").style.backgroundColor = "black";
                            if(peer.id !== undefined){
                                socket.emit("audioMute", {judge: aud ,value: peer.id, id: roomName, name: myName});
                            }
                        }
                    }
                    menuSwitch();
                }
                
                function switch_video(e) {
                    if(peerJudge){
                        console.log("video switch");
                        if (vid == true) {
                            videoTrack.enabled = false;
                            vid = false;
                            document.getElementById("sele_blind").style.backgroundColor = "red";
                        }else {
                            videoTrack.enabled = true;
                            vid = true;
                            document.getElementById("sele_blind").style.backgroundColor = "black";
                        }
                    }
                    menuSwitch();
                }
                
                b_mute.addEventListener("click", switch_audio, false);
                b_blind.addEventListener("click", switch_video, false);
                b_getout.addEventListener("click", getoutRoom, false);
                b_join.addEventListener("click", connectPeer, false);
            });

            peer.on('error', function(err){
                alert(err.message);
                room.close();
                peerJudge = false;
                $('#their-videos').empty();
                $('#their-videos_review').empty();
                $('#self-video').empty();
                document.getElementById("sele_join").style.backgroundColor = "black";
            });
            window.onclose = function() {
                room.close();
                peerJudge = false;
            }
            */

            function connectPeer(e) {

                var localStream = null;
                var peer = null;
                var existingCall = null;
                var room;
                peer = new Peer({
                    key: '2647af86-51da-4e29-be21-abb6af7e1016',
                    debug: 3
                });


                peer.on('open', function(){
                    peerJudge = true;

                    // confirm log
                    console.log("peerOpen");
                    socket.emit("log", {value: "peerOpen"});

                    $('#self-video').append($(
                        '<video id="my-video" height="140px" width="210px" muted="true" style="display: inline-block; position: -webkit-sticky;" autoplay playsinline></video>' +
                        '<div class="my-name" id="name_' + peer.id + '" style="height: 25px; margin: 0; padding: 0; background-color: #333333; color: #ffffff; position: relative; z-index:10;">' + 
                            myName + 
                        '</div>'));
                    navigator.mediaDevices = navigator.mediaDevices || ((navigator.mozGetUserMedia || navigator.webkitGetUserMedia) ? {
                        getUserMedia: function(c) {
                            return new Promise(function(y, n) {
                            (navigator.mozGetUserMedia ||
                                navigator.webkitGetUserMedia).call(navigator, c, y, n);
                            });
                        }
                    } : null);

                    if (!navigator.mediaDevices) {
                        console.log("getUserMedia() not supported.");
                        return;
                    }
                    var constraints = { 
                        video: { 
                            frameRate: { ideal: 10, max: 30 }, 
                            width: { min: 160, ideal: 640, max: 1920 }, 
                            height: { min: 120, ideal: 480, max: 1080 }
                        },  
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }};


                    navigator.mediaDevices.getUserMedia(constraints).then(stream => {
                        $('#my-video').get(0).srcObject = stream;
                        localStream = stream;

                        // トラックを取り出す
                        videoTrack = stream.getVideoTracks()[0];
                        audioTrack = stream.getAudioTracks()[0];

                        room = peer.joinRoom('mesh_video_' + roomName, {stream: localStream});
                        room.on('stream', stream => {
                            const peerId = stream.peerId;
                            const id = peerId + '_' + stream.id.replace('{', '').replace('}', '');

                            $('#their-videos').append($(
                            '<div class="video_' + peerId +'" id="video_' + id + '" style="display: inline-block; margin:5px; width: 95%; height: 95%;">' + 
                                '<div class="peer-name" id="name_' + peerId + '" style="height: 25px; background-color: rgba(50,50,50,0.5); color: #ffffff; position: relative; font-size: 16px; z-index:10;">' + 
                                    "guest" + 
                                '</div>' + 
                                '<div class="peer-audio" id="mute_' + peerId + '" style="height: 25px; background-color: red; color: black; font-size: 16px; display: none; position: relative; z-index:10;">音声オフ</div>' + 
                                '<div class="peer-video" style="display: inline-block; width: 100%; height: 100%; margin-top: -25px;">' + 
                                    '<video class="remoteVideos" height="100%" width="100%" style="display: inline-block; position: -webkit-sticky;" autoplay playsinline></video>' +
                                    '<audio class="remoteAudios" style="display: none;" autoplay playsinline></audio>' + 
                                '</div>' + 
                            '</div>'));
                            $('#their-videos_review').append($(
                            '<div class="video_' + peerId +'" id="video_' + id + '_review" style="display: inline-block; margin:5px; width: 95%; height: 95%;">' + 
                                '<div class="peer-name" id="name_' + peerId + '_review" style="height: 25px; background-color: rgba(50,50,50,0.5); color: #ffffff; position: relative; font-size: 16px; z-index:10;">' + 
                                    "guest" + 
                                '</div>' + 
                                '<div class="peer-audio" id="mute_' + peerId + '_review" style="height: 25px; background-color: red; color: black; font-size: 16px; display: none; position: relative; z-index:10;">音声オフ</div>' + 
                                '<div class="peer-video" style="display: inline-block; width: 100%; height: 100%; margin-top: -25px;">' + 
                                    '<video class="remoteVideos" height="100%" width="100%" style="display: inline-block; position: -webkit-sticky;" autoplay playsinline></video>' +
                                '</div>' + 
                            '</div>'));
                            const el = $('#video_' + id).find('video').get(0);
                            const revel = $('#video_' + id + '_review').find('video').get(0);
                            const ael = $('#video_' + id).find('audio').get(0);
                            el.muted = true;
                            el.srcObject = stream;
                            revel.muted = true;
                            revel.srcObject = stream;
                            ael.srcObject = stream;
                            el.play();
                            revel.play();
                            ael.play();
                            defName();
                        });




                        room.on('removeStream', function(stream) {
                            const peerId = stream.peerId;
                            $('#video_' + peerId + '_' + stream.id.replace('{', '').replace('}', '')).remove();
                            $('#video_' + peerId + '_' + stream.id.replace('{', '').replace('}', '') + '_review').remove();
                        });

                        // UI stuff
                        room.on('close', function() {
                            room.close();
                            peerJudge = false;
                            $('#their-videos').empty();
                            $('#their-videos_review').empty();
                            $('#self-video').empty();
                        });
                        room.on('peerLeave', peerId => {
                            $('.video_' + peerId).remove();
                            $('.video_' + peerId + '_review').remove();
                        });
                    });
                });

                peer.on('error', function(err){
                    alert(err.message);
                    room.close();
                    peerJudge = false;
                    $('#their-videos').empty();
                    $('#their-videos_review').empty();
                    $('#self-video').empty();
                });
                window.onclose = function() {
                    room.close();
                    peerJudge = false;
                }
                menuSwitch();
            } 

            function getoutRoom(e) {
                if(peerJudge) {
                    room.close();
                    peerJudge = false;
                    $('#their-videos').empty();
                    $('#their-videos_review').empty();
                    $('#self-video').empty();
                    document.getElementById("sele_join").style.backgroundColor = "black";
                }else {
                    alert("peer disconnected!");
                }
                menuSwitch();
            }

            // b_mute.onclick = switch_audio();
            function switch_audio(e) {
                if(peerJudge) {
                    if (aud == true) {
                        // ビデオをmuteする
                        audioTrack.enabled = false;
                        aud = false;
                        document.getElementById("sele_mute").style.backgroundColor = "red";
                        if(peer.id !== undefined){
                            socket.emit("audioMute", {judge: aud ,value: peer.id, id: roomName, name: myName});
                        }
                    }else {
                        audioTrack.enabled = true;
                        aud = true;
                        document.getElementById("sele_mute").style.backgroundColor = "black";
                        if(peer.id !== undefined){
                            socket.emit("audioMute", {judge: aud ,value: peer.id, id: roomName, name: myName});
                        }
                    }
                }
                menuSwitch();
            }
            socket.on("returnMute", function(data) {
                if(peerJudge) {
                    if(data.judge == true) {
                        document.getElementById("mute_" + data.value).style.display = "none";
                        document.getElementById("mute_" + data.value + "_review").style.display = "none";
                    }else {
                        document.getElementById("mute_" + data.value).style.display = "block";
                        document.getElementById("mute_" + data.value + "_review").style.display = "block";
                    }
                }
            });
            function switch_video(e) {
                if(peerJudge){
                    console.log("video switch");
                    if (vid == true) {
                        videoTrack.enabled = false;
                        vid = false;
                        document.getElementById("sele_blind").style.backgroundColor = "red";
                    }else {
                        videoTrack.enabled = true;
                        vid = true;
                        document.getElementById("sele_blind").style.backgroundColor = "black";
                    }
                }
                menuSwitch();
            }

            

            /////////////////////////
            //  テキストチャット    //
            /////////////////////////
            function appendMsg(data) {
                console.log(data.name);
                if(data.name == myName) {
                    $("#bms_messages").append("<div class='bms_message bms_left'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    data.value + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                    $("#chat_review").append("<div class='bms_message bms_left'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    data.value + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                }else {
                    $("#bms_messages").append("<div class='bms_message bms_right'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    data.value + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                    $("#chat_review").append("<div class='bms_message bms_right'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    data.value + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                }
                $('#bms_messages').animate({ scrollTop: $('#bms_messages')[0].scrollHeight }, 'fast');
                $('#chat_review').animate({ scrollTop: $('#chat_review')[0].scrollHeight }, 'fast');
            }

            socket.on("returnChat", function (data) {
                appendMsg(data);
                console.log(data);
            });

            $("#bms_send_btn").click(function (e) {
                var message = $("#bms_send_message").val();
                $("#bms_send_message").val('');
                socket.emit("sendChat", { value: message, id: roomName, name: myName });
                e.preventDefault();
            });


            // upload to chat
            socket.on("addThum", function drawBoard(data) {
                if(data.name == myName) {
                    $("#bms_messages").append("<div class='bms_message bms_left'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    "<canvas id = 'thum_" + thumb + "' style = 'display: none;'></canvas>" + "<br />" + 
                                                                    "<canvas id = 'thum_" + thumb + "_mini' width = '150' height = '150'></canvas>" + "<br />" + 
                                                                    "<input type = 'button' class = '" + thumb + "' value = 'download' onClick = 'downloadThum(this)'></input>" + 
                                                                    // "<input type = 'button' class = '" + thumb + "' value = 'toBoard' onClick = 'toBoard(this)'></input>" + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                    $("#chat_review").append("<div class='bms_message bms_left'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    "<canvas id = 'thum_" + thumb + "_review' width = '150' height = '150'></canvas>" + "<br />" + 
                                                                    "<input type = 'button' class = '" + thumb + "' value = 'download' onClick = 'downloadThum(this)'></input>" + 
                                                                    // "<input type = 'button' class = '" + thumb + "' value = 'toBoard' onClick = 'toBoard(this)'></input>" + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                }else {
                    $("#bms_messages").append("<div class='bms_message bms_right'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    "<canvas id = 'thum_" + thumb + "' style = 'display: none;'></canvas>" + "<br />" + 
                                                                    "<canvas id = 'thum_" + thumb + "_mini' width = '150' height = '150'></canvas>" + "<br />" + 
                                                                    "<input type = 'button' class = '" + thumb + "' value = 'download' onClick = 'downloadThum(this)'></input>" + 
                                                                    // "<input type = 'button' class = '" + thumb + "' value = 'toBoard' onClick = 'toBoard(this)'></input>" + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                    $("#chat_review").append("<div class='bms_message bms_right'>" + 
                                                    "<div class='bms_message_box'>" + 
                                                        "<div class='bms_message_content'>" + 
                                                            "<div class='bms_message_text'>" + 
                                                                    data.name + ":" + "<br />" + 
                                                                    "<canvas id = 'thum_" + thumb + "_review' width = '150' height = '150'></canvas>" + "<br />" + 
                                                                    "<input type = 'button' class = '" + thumb + "' value = 'download' onClick = 'downloadThum(this)'></input>" + 
                                                                    // "<input type = 'button' class = '" + thumb + "' value = 'toBoard' onClick = 'toBoard(this)'></input>" + 
                                                            "</div>" + 
                                                        "</div>" + 
                                                    "</div>" + 
                                                "</div>" + 
                                                "<div class='bms_clear'></div>");
                }
                $('#bms_messages').animate({ scrollTop: $('#bms_messages')[0].scrollHeight }, 'fast');
                $('#chat_review').animate({ scrollTop: $('#chat_review')[0].scrollHeight }, 'fast');

                var thumb_canvas = document.getElementById("thum_" + thumb);
                var thumb_ctx = thumb_canvas.getContext('2d');
                thumb_ctx.imageSmoothingQuality = "high";            
                var mini_canvas = document.getElementById("thum_" + thumb + "_mini");
                var mini_ctx = mini_canvas.getContext('2d');
                mini_ctx.imageSmoothingQuality = "high";            
                var mini_canvas_review = document.getElementById("thum_" + thumb + "_review");
                var mini_ctx_review = mini_canvas_review.getContext('2d');
                mini_ctx.imageSmoothingQuality = "high";            
                var thu = new Image();
                thu.src = data.value;
                thu.onload = function() {
                    var tw = this.width;
                    var th = this.height;
                    thumb_canvas.width = tw;
                    thumb_canvas.height = th;
                    thumb_ctx.drawImage(thu, 0, 0, tw, th);
                    var thuAsp = tw/th;
                    if (thuAsp < 1) {
                        var rat = tw * 150 / th;
                        mini_canvas.width = rat;
                        mini_ctx.drawImage(thu, 0, 0, rat, 150);
                        mini_ctx_review.drawImage(thu, 0, 0, rat, 150);
                        
                    }else {
                        var rat = th * 150 / tw;
                        mini_canvas.height = rat;
                        mini_ctx.drawImage(thu, 0, 0, 150, rat);
                        mini_ctx_review.drawImage(thu, 0, 0, 150, rat);
                    }
                }

                thumb ++;
            });


            function loadLocalThum(e) {
                // ファイル情報を取得
                fileData = e.target.files[0];

                // 画像ファイル以外は処理を止める
                if(!fileData.type.match('image.*')) {
                    alert('画像を選択してください');
                    return;
                }

                // FileReaderオブジェクトを使ってファイル読み込み
                reader = new FileReader();
                // ファイル読み込みに成功したときの処理
                reader.onload = function(e) {
                    // Canvas上に表示する
                    uploadImgSrc = e.target.result;
                    socket.emit("sendThum", { value: uploadImgSrc, id: roomName, name: myName });
                }
                // ファイル読み込みを実行
                reader.readAsDataURL(fileData);
                menuSwitch();
            }

            // ファイルが指定された時にloadLocalImage()を実行
            // input_chat_file.addEventListener('change', loadLocalThum, false);

            // draw image of chat on myCanvas
            /*
            socket.on("addBoard", function drawBoard(data) {
                drawImgOnCvs(data);
            });
            function toBoard(e) {
                thumb_canvas = document.getElementById("thum_" + e.className);
                base64 = thumb_canvas.toDataURL("image/png");
                socket.emit("thumToBoard", { value: base64, id: roomName, name: myName });
            }
            */

            // download from chat
            function downloadThum(e) {
                thumb_canvas = document.getElementById("thum_" + e.className);
                toPicture(thumb_canvas);
            }


            /*
            function bkCanvas() {
                console.log("bk");
                canvas = document.getElementById("myCanvas");
                context = canvas.getContext('2d');
                base64 = canvas.toDataURL("image/png");
                context.imageSmoothingQuality = "high";
            }
            function recoverCanvas() {
                console.log("drow");
                canvas = document.getElementById("myCanvas");
                context = canvas.getContext('2d');
                bkData = new Image();
                bkData.onload = function() {
                    context.drawImage(bkData, 0, 0, canvas.width, canvas.height);
                }
                bkData.src = base64;
            }
            */




            //////////////////////////
            //  menubar def name    //
            //////////////////////////
            function defName(){
                myName = document.getElementById("myNameForm").value;         
                socket.emit("sendReq", { id: roomName });
            }
            socket.on("returnReq", function(data) {
                if (peerJudge) {
                    socket.emit("sendName", {id: roomName, tag: peer.id, name: myName});
                }
            });
            socket.on("returnName", function(data) {
                if (peerJudge) {
                    document.getElementById("name_" + data.tag).textContent = data.name;
                }
            });
            function changeName(e) {
                myName = document.getElementById("myNameForm").value;         
                if (peerJudge) {
                    socket.emit("sendName", {id: roomName, tag: peer.id, name: myName});
                    // room.send(myName);
                }
            }
            // document.getElementById("myNameForm").onchange = changeName();

            ///////////////////////////////////
            //  script list
            ////////////////////////////////
            // L19~28
            // websocket

            


        </script>

    </body>
</html>